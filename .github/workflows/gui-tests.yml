name: GUI Tests - Selenium

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'front-end/**'
      - 'tests/gui/**'
      - '.github/workflows/gui-tests.yml'
  workflow_dispatch:  # Manual trigger
    inputs:
      headless:
        description: 'Run tests in headless mode'
        required: false
        default: 'true'

jobs:
  gui-tests:
    name: Run GUI Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        python-version: ['3.11']
        node-version: ['20']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: front-end/model-registry-frontend/package-lock.json

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Verify Chrome installation
        run: |
          which google-chrome-stable
          google-chrome-stable --version

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('dependencies.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r dependencies.txt
          pip install selenium webdriver-manager pytest-asyncio

      - name: Install frontend dependencies
        working-directory: front-end/model-registry-frontend
        run: |
          npm ci

      - name: Create database and run migrations
        run: |
          # Create SQLite database for testing
          mkdir -p data
          export DATABASE_URL="sqlite:///./data/test.db"
          python -c "from src.core.database import create_tables; create_tables()"

      - name: Start backend server
        run: |
          export DATABASE_URL="sqlite:///./data/test.db"
          export LOG_LEVEL="INFO"
          uvicorn src.api.main:app --host 0.0.0.0 --port 8000 &
          echo $! > backend.pid
          # Wait for backend to be ready
          for i in {1..30}; do
            if curl -s http://localhost:8000/health > /dev/null; then
              echo "Backend is ready!"
              break
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done

      - name: Start frontend server
        working-directory: front-end/model-registry-frontend
        run: |
          export VITE_API_URL="http://localhost:8000"
          npm run dev &
          echo $! > ../../frontend.pid
          # Wait for frontend to be ready
          for i in {1..30}; do
            if curl -s http://localhost:5173 > /dev/null; then
              echo "Frontend is ready!"
              break
            fi
            echo "Waiting for frontend... ($i/30)"
            sleep 2
          done

      - name: Verify services are running
        run: |
          curl -f http://localhost:8000/health || (echo "Backend not responding" && exit 1)
          curl -f http://localhost:5173 || (echo "Frontend not responding" && exit 1)

      - name: Run GUI tests
        env:
          FRONTEND_URL: http://localhost:5173
          API_URL: http://localhost:8000
          HEADLESS: ${{ github.event.inputs.headless || 'true' }}
          PYTHONPATH: .
        run: |
          python -m pytest tests/gui/ -v --tb=short --maxfail=5

      - name: Take screenshots on failure
        if: failure()
        run: |
          mkdir -p test-artifacts/screenshots
          if [ -d "tests/gui/screenshots" ]; then
            cp -r tests/gui/screenshots/* test-artifacts/screenshots/ || true
          fi

      - name: Collect logs on failure
        if: failure()
        run: |
          mkdir -p test-artifacts/logs
          if [ -f "logs/app.log" ]; then
            cp logs/app.log test-artifacts/logs/ || true
          fi
          # Get backend logs
          if [ -f "backend.pid" ]; then
            ps aux | grep uvicorn || true
          fi

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gui-test-artifacts-${{ matrix.python-version }}
          path: test-artifacts/
          retention-days: 7

      - name: Stop servers
        if: always()
        run: |
          if [ -f "backend.pid" ]; then
            kill $(cat backend.pid) || true
          fi
          if [ -f "frontend.pid" ]; then
            kill $(cat frontend.pid) || true
          fi
          # Kill any remaining processes
          pkill -f "uvicorn" || true
          pkill -f "vite" || true

  gui-tests-docker:
    name: Run GUI Tests (Docker)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium webdriver-manager pytest-asyncio

      - name: Create .env file
        run: |
          cat > .env << EOF
          POSTGRES_DB=model_registry
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=postgres
          DATABASE_URL=postgresql://postgres:postgres@db:5432/model_registry
          SECRET_KEY=test-secret-key
          LOG_LEVEL=INFO
          VITE_API_URL=http://localhost:8000
          EOF

      - name: Start Docker stack
        run: |
          docker-compose up -d
          # Wait for services to be healthy
          echo "Waiting for services to be ready..."
          sleep 30
          docker-compose ps

      - name: Verify services are running
        run: |
          curl -f http://localhost:8000/health || (docker-compose logs backend && exit 1)
          curl -f http://localhost:5173 || (docker-compose logs frontend && exit 1)

      - name: Install Chrome for tests
        uses: browser-actions/setup-chrome@v1

      - name: Run GUI tests against Docker stack
        env:
          FRONTEND_URL: http://localhost:5173
          API_URL: http://localhost:8000
          HEADLESS: true
          PYTHONPATH: .
        run: |
          python -m pytest tests/gui/ -v --tb=short

      - name: Collect Docker logs on failure
        if: failure()
        run: |
          mkdir -p test-artifacts/docker-logs
          docker-compose logs backend > test-artifacts/docker-logs/backend.log
          docker-compose logs frontend > test-artifacts/docker-logs/frontend.log
          docker-compose logs db > test-artifacts/docker-logs/db.log

      - name: Upload Docker test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gui-test-docker-artifacts
          path: test-artifacts/
          retention-days: 7

      - name: Stop Docker stack
        if: always()
        run: |
          docker-compose down -v

  test-summary:
    name: GUI Test Summary
    runs-on: ubuntu-latest
    needs: [gui-tests, gui-tests-docker]
    if: always()

    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.gui-tests.result }}" == "failure" ] || [ "${{ needs.gui-tests-docker.result }}" == "failure" ]; then
            echo "❌ GUI tests failed"
            exit 1
          elif [ "${{ needs.gui-tests.result }}" == "success" ] && [ "${{ needs.gui-tests-docker.result }}" == "success" ]; then
            echo "✅ All GUI tests passed"
          else
            echo "⚠️ Some tests were skipped or cancelled"
          fi
