name: Deploy to AWS

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: model-registry
  ECR_BACKEND_REPO: model-registry-backend
  ECR_FRONTEND_REPO: model-registry-frontend

jobs:
  # Continuous Integration - Run tests on every PR
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8 bandit

      - name: Run linting
        run: |
          flake8 src/ --max-line-length=120 --exclude=__pycache__,*.pyc

      - name: Run security scan
        run: |
          bandit -r src/ -ll

      - name: Run tests with coverage
        run: |
          pytest tests/ --cov=src --cov-report=xml --cov-report=term-missing

      - name: Upload coverage reports
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml
          flags: unittests
          fail_ci_if_error: false

  # Continuous Deployment - Deploy to AWS on merge to main
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Get AWS Account ID
        id: get-account-id
        run: |
          echo "ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_OUTPUT

      - name: Build, tag, and push backend image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Build backend image
          docker build -t $ECR_REGISTRY/$ECR_BACKEND_REPO:$IMAGE_TAG -f Dockerfile.production .
          docker tag $ECR_REGISTRY/$ECR_BACKEND_REPO:$IMAGE_TAG $ECR_REGISTRY/$ECR_BACKEND_REPO:latest

          # Push to ECR
          docker push $ECR_REGISTRY/$ECR_BACKEND_REPO:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_BACKEND_REPO:latest

          echo "Backend image pushed: $ECR_REGISTRY/$ECR_BACKEND_REPO:$IMAGE_TAG"

      - name: Build, tag, and push frontend image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Build frontend image
          cd front-end/model-registry-frontend
          docker build -t $ECR_REGISTRY/$ECR_FRONTEND_REPO:$IMAGE_TAG -f Dockerfile.production .
          docker tag $ECR_REGISTRY/$ECR_FRONTEND_REPO:$IMAGE_TAG $ECR_REGISTRY/$ECR_FRONTEND_REPO:latest

          # Push to ECR
          docker push $ECR_REGISTRY/$ECR_FRONTEND_REPO:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_FRONTEND_REPO:latest

          echo "Frontend image pushed: $ECR_REGISTRY/$ECR_FRONTEND_REPO:$IMAGE_TAG"

      - name: Update ECS task definition for backend
        id: task-def-backend
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Get current task definition
          TASK_DEFINITION=$(aws ecs describe-task-definition \
            --task-definition $PROJECT_NAME-backend \
            --query taskDefinition)

          # Update image in task definition
          NEW_TASK_DEF=$(echo $TASK_DEFINITION | jq --arg IMAGE "$ECR_REGISTRY/$ECR_BACKEND_REPO:$IMAGE_TAG" \
            '.containerDefinitions[0].image = $IMAGE | del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)')

          # Register new task definition
          NEW_TASK_INFO=$(aws ecs register-task-definition --cli-input-json "$NEW_TASK_DEF")
          NEW_REVISION=$(echo $NEW_TASK_INFO | jq -r '.taskDefinition.revision')

          echo "New task definition revision: $NEW_REVISION"
          echo "TASK_REVISION=$NEW_REVISION" >> $GITHUB_OUTPUT

      - name: Deploy to ECS
        env:
          TASK_REVISION: ${{ steps.task-def-backend.outputs.TASK_REVISION }}
        run: |
          # Update service to use new task definition
          aws ecs update-service \
            --cluster $PROJECT_NAME-cluster \
            --service $PROJECT_NAME-backend-service \
            --task-definition $PROJECT_NAME-backend:$TASK_REVISION \
            --force-new-deployment

          echo "Deployment initiated. Service will update with new task definition."

      - name: Wait for service stability
        run: |
          echo "Waiting for service to stabilize (this may take several minutes)..."
          aws ecs wait services-stable \
            --cluster $PROJECT_NAME-cluster \
            --services $PROJECT_NAME-backend-service

          echo "Service is stable and running with new task definition."

      - name: Get deployment info
        id: deployment-info
        run: |
          # Get load balancer DNS
          ALB_DNS=$(aws elbv2 describe-load-balancers \
            --names $PROJECT_NAME-alb \
            --query 'LoadBalancers[0].DNSName' \
            --output text)

          echo "Deployment complete!"
          echo "API URL: http://$ALB_DNS"
          echo "API_URL=http://$ALB_DNS" >> $GITHUB_OUTPUT

      - name: Test deployment
        env:
          API_URL: ${{ steps.deployment-info.outputs.API_URL }}
        run: |
          # Wait a few seconds for load balancer to register new targets
          sleep 10

          # Test health endpoint
          echo "Testing health endpoint..."
          curl -f $API_URL/health || exit 1

          echo "Health check passed!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful!"
            echo "API: ${{ steps.deployment-info.outputs.API_URL }}"
          else
            echo "❌ Deployment failed!"
            exit 1
          fi

  # Post-deployment smoke tests
  smoke-test:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get API URL
        id: get-url
        run: |
          ALB_DNS=$(aws elbv2 describe-load-balancers \
            --names $PROJECT_NAME-alb \
            --query 'LoadBalancers[0].DNSName' \
            --output text)
          echo "API_URL=http://$ALB_DNS" >> $GITHUB_OUTPUT

      - name: Test API endpoints
        env:
          API_URL: ${{ steps.get-url.outputs.API_URL }}
        run: |
          # Test health endpoint
          echo "Testing /health endpoint..."
          curl -f $API_URL/health

          # Test docs endpoint
          echo "Testing /docs endpoint..."
          curl -f -s $API_URL/docs > /dev/null

          # Test authentication
          echo "Testing authentication..."
          TOKEN=$(curl -s -X POST $API_URL/authenticate \
            -H "Content-Type: application/json" \
            -d '{"username":"ece30861defaultadminuser","password":"correcthorsebatterystaple123(!__+@**(A;DROP TABLE packages"}' \
            | jq -r '.token')

          if [ "$TOKEN" == "null" ] || [ -z "$TOKEN" ]; then
            echo "Authentication failed!"
            exit 1
          fi

          echo "✅ All smoke tests passed!"

      - name: Create deployment report
        if: always()
        run: |
          echo "## Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **API URL**: ${{ steps.get-url.outputs.API_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
