name: Copilot Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  copilot-review:
    name: GitHub Copilot Code Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch all history for better context

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v47
        with:
          files: |
            **/*.py
            **/*.ts
            **/*.tsx
            **/*.js
            **/*.jsx

      - name: AI Code Review
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: coderabbitai/ai-pr-reviewer@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          debug: false
          review_simple_changes: false
          review_comment_lgtm: false
          path_filters: |
            **/*.py
            **/*.ts
            **/*.tsx
            **/*.js
            **/*.jsx
          system_message: |
            You are an expert code reviewer for a Trustworthy Model Registry project.
            Focus on:
            - Security vulnerabilities (SQL injection, XSS, CSRF, authentication issues)
            - OWASP Top 10 compliance
            - Accessibility issues (WCAG 2.1 Level AA)
            - Performance concerns
            - Code quality and best practices
            - Type safety
            - Error handling
            - Test coverage

            Be constructive and provide specific suggestions with code examples when possible.

      - name: Comment on PR
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const files = '${{ steps.changed-files.outputs.all_changed_files }}'.split(' ');
            const filesList = files.map(f => `- \`${f}\``).join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ¤– AI Code Review Triggered

              Reviewing ${files.length} changed file(s):
              ${filesList}

              **Review Focus Areas:**
              - ðŸ”’ Security & OWASP compliance
              - â™¿ Accessibility (WCAG 2.1 AA)
              - ðŸŽ¯ Code quality & best practices
              - âš¡ Performance
              - ðŸ§ª Test coverage

              Results will be posted shortly...`
            });

  manual-review-checklist:
    name: Post Manual Review Checklist
    runs-on: ubuntu-latest

    steps:
      - name: Post review checklist
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ“‹ Manual Review Checklist

              Please ensure the following before merging:

              ### Security
              - [ ] No hardcoded secrets or credentials
              - [ ] Input validation present for all user inputs
              - [ ] SQL injection protection (parameterized queries)
              - [ ] XSS protection (sanitized outputs)
              - [ ] Authentication/authorization checks in place
              - [ ] OWASP Top 10 compliance verified

              ### Testing
              - [ ] Unit tests added/updated
              - [ ] Integration tests pass
              - [ ] Code coverage maintained (>60%)
              - [ ] GUI tests pass (if frontend changes)
              - [ ] Accessibility tests pass (if UI changes)

              ### Accessibility (if UI changes)
              - [ ] ARIA labels present
              - [ ] Keyboard navigation works
              - [ ] Screen reader compatible
              - [ ] Color contrast meets WCAG AA (4.5:1)
              - [ ] Focus indicators visible

              ### Code Quality
              - [ ] Follows project coding standards
              - [ ] No code duplication
              - [ ] Error handling implemented
              - [ ] Logging added for important operations
              - [ ] Documentation updated

              ### Performance
              - [ ] No N+1 queries
              - [ ] Efficient algorithms used
              - [ ] Large data sets handled properly
              - [ ] No memory leaks

              ### Documentation
              - [ ] README updated (if needed)
              - [ ] API documentation updated (if needed)
              - [ ] Comments added for complex logic
              - [ ] Changelog updated

              ---
              *This checklist is automatically posted for all PRs. Check applicable items.*`
            });

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Python Security Check
        run: |
          pip install bandit safety
          bandit -r src/ -f json -o bandit-report.json || true
          safety check --json > safety-report.json || true

      - name: Comment security findings
        uses: actions/github-script@v8
        if: always()
        with:
          script: |
            const fs = require('fs');
            let comment = '## ðŸ”’ Security Scan Results\n\n';

            try {
              const bandit = JSON.parse(fs.readFileSync('bandit-report.json', 'utf8'));
              const highSeverity = bandit.results.filter(r => r.issue_severity === 'HIGH' || r.issue_severity === 'CRITICAL');

              if (highSeverity.length > 0) {
                comment += 'âš ï¸ **Bandit found security issues:**\n';
                highSeverity.forEach(issue => {
                  comment += `- \`${issue.filename}:${issue.line_number}\` - ${issue.issue_text}\n`;
                });
              } else {
                comment += 'âœ… No high-severity issues found by Bandit\n';
              }
            } catch (e) {
              comment += 'âœ… Bandit scan completed\n';
            }

            comment += '\n---\n*View detailed results in the Actions tab*';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
